# =================================
# dev.zeloso.jp CA version
# =================================
# -----------------------------------
# SOUND HOUSE
# -----------------------------------
server {
  listen       80;
  server_name  www.soundhouse.local.jp;
  access_log   /var/log/nginx/www.soundhouse.local.log;
  error_log    /var/log/nginx/www.soundhouse.local.error.log;
  root         /soundhouse/www.soundhouse.co.jp/webroot;
  index        index.php index.html;
  charset      utf-8;

  include      /etc/nginx/conf.d/soundhouse/common.conf;
  include      /etc/nginx/conf.d/soundhouse/common_www.conf;

  add_header X-Frame-Options "SAMEORIGIN";

  set $dir "";

  if ($request_uri ~ ^/contents/.*$) {
    set $dir "/contents";
  }

  # FAQ maintenance 2017.11.06 add
  if ($request_uri ~ ^/faq/.*$) {
    set $dir "/faq";
  }

  location ~ ^/order/loan/jaccs(.*)$ {
    charset shift_jis;
  }

  # basic auth test
  location /basic_auth_test {
    auth_basic "ID";
    auth_basic_user_file "/etc/nginx/conf.d/.sh_htpasswd";
  }


  location ~ .+\.(jpg|jpeg|gif|css|png|js|ico|swf|pdf|xml)$ {
    access_log off;
  }

  location / {
    if ($uri ~ \.jpg) {
      access_log off;
    }

    try_files $uri $uri/ $dir/index.php?$uri&$args $dir/*.asp;

    if (-f $request_filename) {
      expires 30d;
      break;
    }

    if (!-e $request_filename) {
      rewrite ^(.*)$ $dir/index.php?$uri&$args last;
    }
 }

  location ~ [^/]\.js {
    valid_referers none server_names;
    if ($invalid_referer) {
      return 403;
    }
    access_log off;
  }

  location ~* \.(php|asp)$ {
    add_header debug_document_root "$document_root";
    add_header debug_fastcgi_script_name "$fastcgi_script_name";
    add_header debug_dir "$dir";

    set $do_not_cache 0;
    if ($request_method != GET) {
      set $do_not_cache 1;
    }

    fastcgi_split_path_info  ^(.+\.php)(/.+)$;
    fastcgi_index            index.php;
    fastcgi_pass             php:9000;
    include                  /etc/nginx/fastcgi_params;
    include                  /etc/nginx/fastcgi_params2;
    fastcgi_param            SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param            PHP_FLAG "log_errors On";
    fastcgi_param            PGP_VALUE "error_log=\"/soundhouse/www.soundhouse.co.jp/fw/app/tmp/logs/php_error.log\"";
    fastcgi_intercept_errors on;
    fastcgi_ignore_client_abort off;
    fastcgi_connect_timeout 60;
    fastcgi_send_timeout 90;
    fastcgi_read_timeout 90;
    fastcgi_buffer_size 128k;
    fastcgi_buffers 4 256k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_temp_file_write_size 256k;
  }
}


# -----------------------
# SOUND HOUSE SSL
# -----------------------
server {
  listen 443 ssl;
  server_name www.soundhouse.local.jp;

  # dev.zeloso.jp
  ssl_certificate      /etc/nginx/ssl/crt.pem;
  ssl_certificate_key  /etc/nginx/ssl/privkey.pem;
  ssl_password_file    /etc/nginx/ssl/passwd;

  ssl_protocols        SSLv3 TLSv1.2 TLSv1.3;
  ssl_ciphers          HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers on;
  ssl_session_cache    shared:SSL:1024m;
  ssl_session_timeout  15m;
  access_log           /var/log/nginx/www.soundhouse.local.log;
  error_log            /var/log/nginx/www.soundhouse.local.error.log;

  root                 /soundhouse/www.soundhouse.co.jp/webroot;
  index                index.php;
  fastcgi_index        index.php;
  charset              utf-8;

  include              /etc/nginx/conf.d/soundhouse/common.conf;
  include              /etc/nginx/conf.d/soundhouse/common_www.conf;

  autoindex on;
  autoindex_exact_size off;
  autoindex_localtime on;

  add_header X-Frame-Options "SAMEORIGIN";

  # for development environment
  add_header Strict-Transport-Security 'max-age=31536000; includeSubDomains;preload';

  client_max_body_size 8M;

  set $dir "";

  # blog
  if ($request_uri ~ ^/contents/.*$) {
    set $dir "/contents";
  }
  if ($request_uri ~ ^/en/contents/.*$) {
    set $dir "/en/contents";
  }

  # FAQ maintenance 2017.11.06 add
  if ($request_uri ~ ^/faq/.*$) {
    set $dir "/faq";
  }

  # basic auth test
  location /basic_auth_test {
    auth_basic "ID";
    auth_basic_user_file "/etc/nginx/conf.d/.sh_htpasswd";
  }

  if ($request_uri ~ ^/test/xchange/.*$) {
    set $do_not_cache 1;
  }

  location ~ .+\.(jpg|jpeg|gif|css|png|js|ico|swf|pdf|xml)$ {
    access_log off;
  }

  location / {
    add_header X-CONF_LOCATION "/";

    set $lng "${lng}B";
    try_files $uri $uri/ $dir/index.php?$uri&$args;

    if (!-e $request_filename) {
      rewrite ^(.*)$ $dir/index.php?$uri&$args last;
    }
  }

  location ~* \.php$ {
    fastcgi_split_path_info  ^(.+\.php)(/.+)$;
    fastcgi_index            index.php;
    fastcgi_pass             php:9000;
    include                  /etc/nginx/fastcgi_params;
    include                  /etc/nginx/fastcgi_params2;
    fastcgi_param            SCRIPT_FILENAME $document_root$fastcgi_script_name; 

    fastcgi_intercept_errors on;
    fastcgi_ignore_client_abort off;
    fastcgi_connect_timeout 60;
    fastcgi_send_timeout 90;
    fastcgi_read_timeout 90;

    fastcgi_buffer_size 128k;
    fastcgi_buffers 4 256k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_temp_file_write_size 256k;

    fastcgi_param            PHP_FLAG "log_errors On";
    fastcgi_param            PHP_VALUE "error_log=\"/soundhouse/www.soundhouse.co.jp/fw/app/tmp/logs/php_error.log\"";

    add_header Cache-Control no-store;

    add_header X-CONF_LOCATION "php";
    add_header X-DOCUMENT_ROOT "$document_root";
    add_header X-REQUEST_FILENAME "$request_filename";
    add_header X-FASTCGI_SCRIPT_NAME_PHP $fastcgi_script_name;
  }

  location ~ [^/]\.asp$ {
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include        /etc/nginx/fastcgi_params;
  }


  # for eng
  # static contents redirect
  location ~ ^/en/404/(.*)$ {
    try_files $uri $uri/ /en/404/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /404/$1$is_args$args;
    }
  }
  location ~ ^/en/affiliate/(.*)$ {
    try_files $uri $uri/ /en/affiliate/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /affiliate/$1$is_args$args;
    }
  }
  location ~ ^/en/company/(.*)$ {
    try_files $uri $uri/ /en/company/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /company/$1$is_args$args;
    }
  }
  location ~ ^/en/content/(.*)$ {
    try_files $uri $uri/ /en/content/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /content/$1$is_args$args;
    }
  }
  # blog
  location ~ ^/en/download/(.*)$ {
    try_files $uri $uri/ /en/download/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /download/$1$is_args$args;
    }
  }
  location ~ ^/en/guide/(.*)$ {
    try_files $uri $uri/ /en/guide/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /guide/$1$is_args$args;
    }
  }
  location ~ ^/en/howto/(.*)$ {
    try_files $uri $uri/ /en/howto/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /howto/$1$is_args$args;
    }
  }
  location ~ ^/en/link/(.*)$ {
    try_files $uri $uri/ /en/link/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /link/$1$is_args$args;
    }
  }
  location ~ ^/en/maker/(.*)$ {
    try_files $uri $uri/ /en/maker/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /maker/$1$is_args$args;
    }
  }
  location ~ ^/en/material/(.*)$ {
    try_files $uri $uri/ /en/material/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /material/$1$is_args$args;
    }
  }
  location ~ ^/en/report/(.*)$ {
    try_files $uri $uri/ /en/report/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /report/$1$is_args$args;
    }
  }
  location ~ ^/en/show/(.*)$ {
    try_files $uri $uri/ /en/show/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /show/$1$is_args$args;
    }
  }
  location ~ ^/en/yoitoko/(.*)$ {
    try_files $uri $uri/ /en/yoitoko/$1$is_args$args;
    if (!-e $request_filename) {
      return 302 /yoitoko/$1$is_args$args;
    }
  }
}

